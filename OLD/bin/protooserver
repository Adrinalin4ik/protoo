#!/usr/bin/env node
"use strict";


// Internal dependencies (configure "rekuire").
require("rekuire").ignore("bin", "test", "apps_test");  // TODO: remove "apps_test"

// External dependencies.
var argv = require("yargs")
	.alias("c", "configDir")
	.alias("u", "uid")
	.alias("g", "gid")
	.alias("v", "version")
	.alias("h", "help")
	.boolean(["v", "h"])
	.argv;

// Internal dependencies.
var ProtooServer = require("rekuire")("lib/ProtooServer.js");


function showHelp() {
	var output = "" +
		"ProtooServer " + ProtooServer.version + "\n" +
		"http://protooserver.org\n" +
		"Copyright 2014, IÃ±aki Baz Castillo <ibc@aliax.net>\n" +
		"\n" +
		"Usage: protooserver [Options] [App]\n" +
		"\n" +
		"Options:\n" +
		"  -c, --configDir DIR   Path to the directory with the configuration file(s) (default: './config')\n" +
		"  -u, --uid UID         Change the user (name or numeric) the process runs with\n" +
		"  -g, --gid GID         Change the group (name or numeric) the process runs with\n" +
		"  --processName NAME    Process name (default: 'protooserver')\n" +
		"  --workingDir DIR      Change the working directory (default: '/')\n" +
		"  -v, --version         Show version\n" +
		"  -h, --help            Show this message\n" +
		"\n" +
		"App:\n" +
		"  Absolute path to the user provided application (if not set, a default built-in application is loaded)";

	console.log(output);
}


function showVersion() {
	console.log("ProtooServer " + ProtooServer.version);
}


// Process command line arguments.
if (argv.help) {
	showHelp();
	process.exit(0);
}
else if (argv.version) {
	showVersion();
	process.exit(0);
}

// Set options.
var options = {
	configDir:   (typeof argv.configDir === "string" ? argv.configDir : null),
	uid:         ((typeof argv.uid === "string" || typeof argv.uid === "number") ? argv.uid : null),
	gid:         ((typeof argv.gid === "string" || typeof argv.gid === "number") ? argv.gid : null),
	processName: (typeof argv.processName === "string" ? argv.processName : "protooserver"),
	workingDir:  (typeof argv.workingDir === "string" ? argv.workingDir : "/")
};

// Set app.
var app_path = argv._[0] || require("rekuire").path("DefaultApp");


// Run ProtooServer with the given options and app.
ProtooServer.run(options, app_path);
